<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Carte des Concerts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        .popup-content {
            font-size: 14px;
        }
        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .popup-content .artist-name {
            font-weight: bold;
            color: #e91e63;
            font-size: 16px;
        }
        .popup-content .location {
            color: #666;
            margin-bottom: 8px;
        }
        .popup-content .dates {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
        }
        .popup-content .date-item {
            padding: 2px 0;
            color: #555;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Chargement de la carte...</div>
    <div id="map"></div>

    <script>
        // Initialiser la carte
        var map = L.map('map').setView([48.8566, 2.3522], 3);

        // Ajouter le fond de carte OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Fonction pour gÃ©ocoder une localisation (ville, pays)
        async function geocodeLocation(location) {
            try {
                // Nettoyer le nom de la location
                const cleanLocation = location.replace(/_/g, ' ').replace(/-/g, ', ');
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cleanLocation)}&limit=1`
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Erreur de gÃ©ocodage pour', location, error);
                return null;
            }
        }

        // Fonction appelÃ©e par Go pour ajouter les concerts Ã  la carte
        async function addConcerts(concertsData) {
            document.getElementById('loading').style.display = 'none';
            
            // Regrouper les concerts par location
            const locationMap = new Map();
            
            for (const concert of concertsData) {
                for (const [location, dates] of Object.entries(concert.datesLocations)) {
                    if (!locationMap.has(location)) {
                        locationMap.set(location, []);
                    }
                    locationMap.get(location).push({
                        artist: concert.artistName,
                        dates: dates
                    });
                }
            }

            // Ajouter les marqueurs pour chaque location
            let markersAdded = 0;
            for (const [location, concerts] of locationMap.entries()) {
                // Petit dÃ©lai pour ne pas surcharger l'API de gÃ©ocodage
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const coords = await geocodeLocation(location);
                if (coords) {
                    // CrÃ©er le contenu du popup
                    let popupContent = `<div class="popup-content">`;
                    popupContent += `<div class="location"><strong>${location.replace(/_/g, ' ').replace(/-/g, ', ')}</strong></div>`;
                    
                    concerts.forEach(concert => {
                        popupContent += `<div class="artist-name">${concert.artist}</div>`;
                        popupContent += `<div class="dates">`;
                        concert.dates.slice(0, 5).forEach(date => {
                            popupContent += `<div class="date-item">ðŸ“… ${date}</div>`;
                        });
                        if (concert.dates.length > 5) {
                            popupContent += `<div class="date-item">... et ${concert.dates.length - 5} autres dates</div>`;
                        }
                        popupContent += `</div>`;
                    });
                    
                    popupContent += `</div>`;

                    // Ajouter le marqueur
                    L.marker([coords.lat, coords.lon])
                        .addTo(map)
                        .bindPopup(popupContent);
                    
                    markersAdded++;
                }
            }

            console.log(`${markersAdded} marqueurs ajoutÃ©s sur la carte`);
            
            // Ajuster la vue pour montrer tous les marqueurs
            if (markersAdded > 0) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        }

        // Exposer la fonction globalement pour que Go puisse l'appeler
        window.addConcerts = addConcerts;

        // Message initial
        console.log('Carte prÃªte, en attente des donnÃ©es...');
    </script>
</body>
</html>
